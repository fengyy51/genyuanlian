<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>注册</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../css/animate.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <style>
        .vali_fail{
            border:1px solid red;
            background-color:#ddd;
            color:Red;
            padding-left:30px;
            padding: 5px;
            margin-bottom: 10px;
        }
        #mycanvas{
            cursor: pointer;
        }
    </style>
</head>

<body class="gray-bg">

    <div class="middle-box text-center loginscreen   animated fadeInDown">
        <div>
            <div class="form-group">
                <input type="text" id="username"  class="form-control" placeholder="用户名" >
            </div>
            <div class="form-group">
                <input type="text" id="name"  class="form-control" placeholder="真实姓名" >
            </div>
            <div class="form-group">
                <input type="text" id="phone"  class="form-control" placeholder="联系电话" >
            </div>
            <div class="form-group">
                <input type="text" id="address"  class="form-control" placeholder="地址" >
            </div>
            <div class="form-group">
                <input type="email" id="email"  class="form-control" placeholder="邮箱" >
            </div>
            <div class="form-group">
                <input type="password" id="password"  class="form-control" placeholder="密码(4-16个字符,字母与数字的组合)" >
            </div>
            <div class="form-group">
                <input type="password" id="repassword"  class="form-control" placeholder="再次确认密码" required>
            </div>
            <div class="form-group">
                <input type="password" id="code"  class="form-control" style="margin-right:2px;width: 200px;float: left;" placeholder="输入验证码" required>
                <canvas id="mycanvas" width='90' height='34'>
                    您的浏览器不支持canvas，请换个浏览器试试~
                </canvas>
            </div>

            <span class="vali_fail" style="display: none" id="nameNull">
                用户名不可为空
            </span>
            <span class="vali_fail" style="display: none" id="trnameNull">
                真实姓名不可为空
            </span>
            <span class="vali_fail" style="display: none" id="phoneNull">
                联系电话不可为空
            </span>
            <span class="vali_fail" style="display: none" id="addressNull">
                地址不可为空
            </span>
            <span class="vali_fail" style="display: none" id="emailNull">
                邮箱不可为空
            </span>
            <span class="vali_fail" style="display: none" id="pwdNull">
                密码不可为空
            </span>
            <span class="vali_fail" style="display: none" id="repwdNull">
                确认密码不可为空
            </span>
            <span class="vali_fail" style="display: none" id="codeNull">
                验证码不可为空
            </span>
            <span class="vali_fail" style="display: none" id="pwdWrong">
                密码格式不正确，请重新输入
            </span>
            <span class="vali_fail" style="display: none" id="repwdWrong">
                两次密码不一致，请重新输入
            </span>
            <span class="vali_fail" style="display: none" id="codeWrong">
                验证码不正确，请重新输入
            </span>
            <span class="vali_fail" style="display: none" id="emailWrong">
                邮箱格式不正确，请重新输入
            </span>
            <span class="vali_fail" style="display: none" id="phoneWrong">
                联系电话格式不正确，请重新输入
            </span>
            <span class="vali_fail" style="display: none" id="trnameWrong">
                真实姓名格式不正确，请重新输入
            </span>
            <span class="vali_fail" style="display: none" id="nameWrong">
                用户名已被使用，请重新输入
            </span>
            <button  class="btn btn-primary block full-width m-b" id="submit">注册</button>
            <p class="text-muted text-center"><small>您已经有账户?</small></p>
            <a class="btn btn-sm btn-white btn-block" href="login.html">登录</a>

        </div>
    </div>

    <!-- Mainly scripts -->
    <script src="../js/jquery-3.1.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/publicAttr.js"></script>

    <!--//表单验证-->
    <script>
        $('#username').blur(function () {
            var nameVal=$('#username').val();
            if(nameVal==''){
                $('#nameNull').css("display","block");
            }else{
                $('#nameNull').css("display","none");
            }
        });
        $('#password').blur(function () {
            var pwdVal=$('#password').val();
            if(pwdVal==''){
                $('#pwdNull').css("display","block");
            }else{
                $('#pwdNull').css("display","none");
            }
        });
        $('#repassword').blur(function () {
            var repwdVal=$('#repassword').val();
            if(repwdVal==''){
                $('#repwdNull').css("display","block");
            }else{
                $('#repwdNull').css("display","none");
            }
        });
        $('#code').blur(function () {
            var codeVal=$('#code').val();
            if(codeVal==''){
                $('#codeNull').css("display","block");
            }else{
                $('#codeNull').css("display","none");
            }
        });
        $('#name').blur(function () {
            var nameVal=$('#name').val();
            if(nameVal==''){
                $('#trnameNull').css("display","block");
            }else{
                $('#trnameNull').css("display","none");
            }
            var reg=/^[\u4E00-\u9FA5\uf900-\ufa2d·s]{2,20}$/;
            if(reg.test(nameVal)){
                $('#trnameWrong').css("display","none");
            }else{
                $('#trnameWrong').css("display","block");
            }
        });
        $('#phone').blur(function () {
            var phoneVal=$('#phone').val();
            if(phoneVal==''){
                $('#phoneNull').css("display","block");
            }else{
                $('#phoneNull').css("display","none");
            }
            var reg=/^(0|86|17951)?(13[0-9]|15[012356789]|18[0-9]|14[57])[0-9]{8}$/;
            if(reg.test(phoneVal)){
                $('#phoneWrong').css("display","none");
            }else{
                $('#phoneWrong').css("display","block");
            }
        });
        $('#address').blur(function () {
            var addressVal=$('#address').val();
            if(addressVal==''){
                $('#addressNull').css("display","block");
            }else{
                $('#addressNull').css("display","none");
            }
        });
        $('#email').blur(function () {
            var emailVal=$('#email').val();
            if(emailVal==''){
                $('#emailNull').css("display","block");
            }else{
                $('#emailNull').css("display","none");
            }
            var reg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(.[a-zA-Z0-9_-])+/;
            if(reg.test(emailVal)){
                $('#emailWrong').css("display","none");
            }else {
                $('#emailWrong').css("display","block");
            }
        });
        $('#password').blur(function () {
            var pwdVal=$('#password').val();
//            var reg=/^[0-9a-zA-Z_\u3E00-\u9FA5]{3,15}$/;
            var reg=/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{4,16}$/;

            if(reg.test(pwdVal)){
                $('#pwdWrong').css("display","none");
            }else{
                $('#pwdWrong').css("display","block");
            }
        });
        $('#repassword').blur(function () {
            var pwdVal=$('#password').val();
            var repwdVal=$('#repassword').val();
            if(pwdVal!=repwdVal){
                $('#repwdWrong').css("display","block");
            }else{
                $('#repwdWrong').css("display","none");
            }
        });

    </script>
    <!--用户名是否已使用验证-->
    <script>
        $('#username').blur(function () {
            ifUse();
        });
        function ifUse() {
            var urlIfUse=urlServer+'/user/is-username-ok';
            var username=$('#username').val();
            $.ajax({
                url:urlIfUse,
                data:{
                    username: username,
                },
                success:function (data) {
                    var code=data.code;
                    if(code==200){
                        var result=data.data.result;
                        if(result==false){
                            $('#nameWrong').css("display","none");
                        }else{
                            $('#nameWrong').css("display","block");
                        }
                    }
                },
                error:function (error) {
                    console.log(error);
                    alert("获取用户名是否使用失败！");
                }
            })
        }
    </script>
    <!--生成图片验证码-->
    <script>
//        var code;
        /*生成4位随机数*/
        function rand(){
            var str="0123456789fghabcdejkmnpqrstuvwxyz";
            var arr=str.split("");
            var validate="";
            var ranNum;
            for(var i=0;i<4;i++){
                ranNum=Math.floor(Math.random()*23); //随机数在[0,35]之间
                validate+=arr[ranNum];
            }
            console.log(validate);
            code=validate;
            return validate;
        }
//        $('#code').blur(function () {
//            var codeVal=$('#code').val();
//            console.log(code);
//
//        });
        /*干扰线的随机x坐标值*/
        function lineX(){
            var ranLineX=Math.floor(Math.random()*90);
            return ranLineX;
        }
        /*干扰线的随机y坐标值*/
        function lineY(){
            var ranLineY=Math.floor(Math.random()*40);
            return ranLineY;
        }
        function clickChange(){
            var mycanvas=document.getElementById('mycanvas');
            var cxt=mycanvas.getContext('2d');
            cxt.fillStyle='#fff';
            cxt.fillRect(0,0,90,40);
            /*生成干扰线20条*/
            for(var j=0;j<15;j++){
                cxt.strokeStyle='#6c6c6c ';
                cxt.beginPath(); //若省略beginPath，则每点击一次验证码会累积干扰线的条数
                cxt.moveTo(lineX(),lineY());
                cxt.lineTo(lineX(),lineY());
                cxt.lineWidth=0.5;
                cxt.closePath();
                cxt.stroke();
            }
            cxt.fillStyle='red';
            cxt.font='bold 25px Arial';
            cxt.fillText(rand(),15,25); //把rand()生成的随机数文本填充到canvas中
        }
        clickChange();
        /*点击验证码更换*/
        mycanvas.onclick=function(e){
            e.preventDefault(); //阻止鼠标点击发生默认的行为
            clickChange();
        };
        //改变多次点击验证码变蓝的问题
        $('#mycanvas').bind("selectstart", function () { return false; });

    </script>

    <!--//表单提交-->
    <script>
        $('#submit').click(function () {
            var nameVal=$('#username').val();
            var pwdVal=$('#password').val();
            var repwdVal=$('#repassword').val();
            var codeVal=$('#code').val();
            if(nameVal!=''&&pwdVal!=''&&repwdVal!=''&&codeVal!=''){
                if(codeVal!=code){
                    $('#codeWrong').css("display","block");
                }else{
                    $('#codeWrong').css("display","none");
                }
                var vali_status=false;
                $('.vali_fail').each(function () {
                    if($(this).css("display")=='block'){
                        vali_status=true;
                    }
                });
                if(vali_status==false){
                    $('#submit').css("disabled",true);
                    postForm();
                }

            }else{
                alert("有必填项未按要求填写")
            }

        })
        function postForm() {
            var urlPostReg=urlServer+'/user/register';
            var username=$('#username').val(),
                name=$('#name').val(),
                password=$('#password').val(),
                phone=$('#phone').val(),
                address=$('#address').val(),
                email=$('#email').val();

            $.ajax({
                url:urlPostReg,
                type:"POST",
                data:{
                    username: username,
                    password:password,
                    phone:phone,
                    address:address,
                    email:email,
                    name:name,
                },
                success:function (data) {
                    var code=data.code;
                    if(code==200){
                        var result=data.data.result;
                        if(result==true){
                            window.location.href='login.html';
                        }else{
                            $('#submit').removeAttr("disabled");
                            alert("注册失败，请重试！");
                        }
                    }else{
                        $('#submit').removeAttr("disabled");
                        console.log(data);
                    }
                },
                error:function (error) {
                    $('#submit').removeAttr("disabled");
                    console.log(error);
                    alert("提交注册信息失败！");
                }
            })
        }
    </script>

</body>

</html>
